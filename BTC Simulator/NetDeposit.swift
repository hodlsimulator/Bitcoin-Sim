//
//  NetDeposit.swift
//  BTCMonteCarlo
//
//  Created by . . on 23/01/2025.
//

import Foundation

/// Applies a transaction fee, plus currency conversion, returning net BTC.
func computeNetDeposit(
    typedDeposit: Double,
    settings: SimulationSettings,
    btcPriceUSD: Double,
    btcPriceEUR: Double
) -> (
    feeEUR: Double,
    feeUSD: Double,
    netContribEUR: Double,
    netContribUSD: Double,
    netBTC: Double
) {
    if typedDeposit <= 0 {
        return (0, 0, 0, 0, 0)
    }
    switch settings.currencyPreference {
    case .usd:
        let fee = typedDeposit * 0.006
        let netUSD = typedDeposit - fee
        let netBTC = netUSD / btcPriceUSD
        return (0.0, fee, 0.0, netUSD, netBTC)
        
    case .eur:
        let fee = typedDeposit * 0.006
        let netEUR = typedDeposit - fee
        let netBTC = netEUR / btcPriceEUR
        return (fee, 0.0, netEUR, 0.0, netBTC)
        
    case .both:
        if settings.contributionCurrencyWhenBoth == .eur {
            let fee = typedDeposit * 0.006
            let netEUR = typedDeposit - fee
            let netBTC = netEUR / btcPriceEUR
            return (fee, 0.0, netEUR, 0.0, netBTC)
        } else {
            let fee = typedDeposit * 0.006
            let netUSD = typedDeposit - fee
            let netBTC = netUSD / btcPriceUSD
            return (0.0, fee, 0.0, netUSD, netBTC)
        }
    }
}

func computeNetDepositMonthly(
    typedDeposit: Double,
    monthlySettings: MonthlySimulationSettings,
    btcPriceUSD: Double,
    btcPriceEUR: Double
) -> (
    feeEUR: Double,
    feeUSD: Double,
    netContribEUR: Double,
    netContribUSD: Double,
    netBTC: Double
) {
    // If deposit is 0 or negative, return zero everything.
    guard typedDeposit > 0 else {
        return (0, 0, 0, 0, 0)
    }

    // 0.6% fee, just like your weekly code.
    let feeRate = 0.006

    switch monthlySettings.currencyPreferenceMonthly {
    case .usd:
        let fee = typedDeposit * feeRate
        let netUSD = typedDeposit - fee
        let netBTC = netUSD / btcPriceUSD
        return (0.0, fee, 0.0, netUSD, netBTC)

    case .eur:
        let fee = typedDeposit * feeRate
        let netEUR = typedDeposit - fee
        let netBTC = netEUR / btcPriceEUR
        return (fee, 0.0, netEUR, 0.0, netBTC)

    case .both:
        // If the user picks "Both" for currency, check which sub-currency they're using for monthly
        switch monthlySettings.contributionCurrencyWhenBothMonthly {
        case .eur:
            let fee = typedDeposit * feeRate
            let netEUR = typedDeposit - fee
            let netBTC = netEUR / btcPriceEUR
            return (fee, 0.0, netEUR, 0.0, netBTC)

        case .usd:
            let fee = typedDeposit * feeRate
            let netUSD = typedDeposit - fee
            let netBTC = netUSD / btcPriceUSD
            return (0.0, fee, 0.0, netUSD, netBTC)

        case .both:
            // If your app never really uses "both" inside "both," pick a default (e.g. USD).
            let fee = typedDeposit * feeRate
            let netUSD = typedDeposit - fee
            let netBTC = netUSD / btcPriceUSD
            return (0.0, fee, 0.0, netUSD, netBTC)
        }
    }
}
